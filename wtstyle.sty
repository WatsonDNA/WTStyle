%
% wtstyle.sty
%

% Package declaration
\NeedsTeXFormat{pLaTeX2e}
\ProvidesPackage{wtstyle}[2017/01/14 dev]
\def\wtst@pkgname{wtstyle}
\RequirePackage{xkeyval}

% Messages
\def\wtst@info{\PackageInfo\wtst@pkgname}
\def\wtst@warn{\PackageWarningNoLine\wtst@pkgname}
\def\wtst@error{\PackageError\wtst@pkgname}

% New counts and ifs
\newcount\wtst@tempcnta
\newif\if@wtst@chapter@exist@

% Utilities
\def\wtst@ifundefined#1{\@ifundefined{wtst@#1}}
\def\wtst@if@option@exists{\@ifnextchar[}
\def\wtst@environment@with@option#1[#2]{\begin{wtst@#1}[#2]}
\def\wtst@environment@without@option#1{\begin{wtst@#1}}

\def\wtst@inner@setkeys#1{\setkeys{inner}{key=#1}}
\def\wtst@remove@spaces#1{%
  \define@key{inner}{key}{\def#1{##1}}%
  \expandafter\wtst@inner@setkeys\expandafter{#1}%
  \disable@keys{inner}{key}}

% Package options: set preset name
\let\wtst@preset@name\relax
\DeclareOption*{%
  \ifx\wtst@preset@name\relax
    \edef\wtst@preset@name{\CurrentOption}%
  \else
    \wtst@error{You can use only one preset}%
  \fi}
\ProcessOptions\relax

% check chapter
\@ifundefined{thechapter}{\@wtst@chapter@exist@false}{\@wtst@chapter@exist@true}
\if@wtst@chapter@exist@
  \def\wtst@addtoreset#1{\@addtoreset{#1}{chapter}}
  \let\wtst@thepcounter\thechapter
\else
  \def\wtst@addtoreset#1{\@addtoreset{#1}{section}}
  \let\wtst@thepcounter\thesection
\fi

% Metadata of document
\define@key[wtst]{docinfo}{title}{\title{#1}}
\define@key[wtst]{docinfo}{author}{\author{#1}}
\define@key[wtst]{docinfo}{date}{\date{#1}}

% Load packages
\define@key[wtst]{docstyle}{packages}{%
  \@for\wtst@current@pkg:=#1\do{%
    \wtst@remove@spaces\wtst@current@pkg
    \expandafter\wtst@load@pkg\wtst@current@pkg\wtst@nil}}
\def\wtst@load@pkg{%
  \wtst@if@option@exists{\wtst@load@pkg@with@option}{\wtst@load@pkg@without@option}}
\def\wtst@load@pkg@with@option[#1]#2\wtst@nil{\usepackage[#1]{#2}}
\def\wtst@load@pkg@without@option#1\wtst@nil{\usepackage{#1}}

% Counter styles
\define@key[wtst]{docstyle}{default parent}{\def\wtst@dparent{#1}}
\define@key[wtst]{docstyle}{footnote parent}{\def\wtst@fnparent{#1}}
\define@key[wtst]{docstyle}{equation parent}{\def\wtst@eqparent{#1}}
\define@key[wtst]{docstyle}{figure parent}{\def\wtst@figparent{#1}}
\define@key[wtst]{docstyle}{table parent}{\def\wtst@tabparent{#1}}

\define@key[wtst]{docstyle}{footnote mark}{\def\thefootnote{#1}}

\AtBeginDocument{%
  % Use default parent if specified
  \wtst@ifundefined{fnparent}{\let\wtst@fnparent\wtst@dparent}{}%
  \wtst@ifundefined{eqparent}{\let\wtst@eqparent\wtst@dparent}{}%
  \wtst@ifundefined{figparent}{\let\wtst@figparent\wtst@dparent}{}%
  \wtst@ifundefined{tabparent}{\let\wtst@tabparent\wtst@dparent}{}%
  % Set parent counter
  \wtst@ifundefined{fnparent}{}{%
    \@addtoreset{footnote}{\wtst@fnparent}}%
  \wtst@ifundefined{eqparent}{}{%
    \def\theequation{\@nameuse{the\wtst@eqparent}.\arabic{equation}}%
    \@addtoreset{equation}{\wtst@eqparent}}%
  \wtst@ifundefined{figparent}{}{%
    \def\thefigure{\@nameuse{the\wtst@figparent}.\arabic{figure}}%
    \@addtoreset{figure}{\wtst@figparent}}%
  \wtst@ifundefined{tabparent}{}{%
    \def\thetable{\@nameuse{the\wtst@tabparent}.\arabic{table}}%
    \@addtoreset{table}{\wtst@tabparent}}}

% Font settings
\define@key[wtst]{docstyle}{emph style}{\DeclareTextFontCommand{\emph}{#1}}

% Set keys
\newcommand{\setdocinfo}[1]{\setkeys[wtst]{docinfo}{#1}}
\@onlypreamble\setdocinfo

\newcommand{\setdocstyle}[1]{\setkeys[wtst]{docstyle}{#1}}
\@onlypreamble\setdocstyle

% Load a preset
\ifx\wtst@preset@name\relax\else
  \IfFileExists{wtstyle-\wtst@preset@name.def}{
    \wtst@info{Load preset `\wtst@preset@name'}
    \wtst@tempcnta=\catcode`\@ \catcode`\@=11\relax
    \input{wtstyle-\wtst@preset@name.def}
    \catcode`\@=\wtst@tempcnta
  }{
    \wtst@error{Preset `\wtst@preset@name' does not exist}
  }
\fi

% EOF
\endinput
