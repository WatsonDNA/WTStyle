%
% wtref.sty
%

%%%% package declaration
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{wtref}[2016/02/09 v0.1]
\def\wtrf@pkgname{wtref}
\RequirePackage{xkeyval}

%%%% error messages
\def\wtrf@warn{\PackageWarningNoLine\wtrf@pkgname}
\def\wtrf@error{\PackageError\wtrf@pkgname}

%%%% new if
\newif\if@wtrf@use@scope@
\newif\if@wtrf@common@last@\@wtrf@common@last@false

%%%% new counts
\newcount\wtrf@tempcnta
\newcount\wtrf@tempcntb

%%%% utility
\def\wtrf@name@def#1{\expandafter\def\csname #1\endcsname}
\def\wtrf@name@use#1{\csname #1\endcsname}
\def\wtrf@name@let#1#2{\expandafter\let\csname #1\endcsname #2}
\def\wtrf@name@clear#1{\expandafter\let\csname #1\endcsname\@undefined}
\def\wtrf@if@option@exist{\@ifnextchar[}
\def\wtrf@count@list#1#2{% #1:count-reg #2:list
  #1\z@\@for\wtrf@member:=#2\do{\advance#1\@ne}}
\def\wtrf@check@counter#1{%
  \@ifundefined{c@#1}%
    {\wtrf@error{No counter '#1' defined}}%
    {}}

%%%% options
\let\wtrf@scope\@empty
\DeclareOption{chapter}{%
  \@wtrf@use@scope@true
  \wtrf@check@counter{chapter}%
  \def\wtrf@thechapter{\arabic{chapter}}%
  \def\wtrf@scope{\wtrf@thechapter:}}
\DeclareOption{section}{%
  \@wtrf@use@scope@true
  \wtrf@check@counter{section}%
  \@ifundefined{c@chapter}%
    {\def\wtrf@thesection{\arabic{section}}}%
    {\def\wtrf@thesection{\arabic{chapter}.\arabic{section}}}%
  \def\wtrf@scope{\wtrf@thesection:}}
\DeclareOption{subsection}{%
  \@wtrf@use@scope@true
  \wtrf@check@counter{subsection}%
  \@ifundefined{c@chapter}%
    {\def\wtrf@thesubsection{\arabic{section}.\arabic{subsection}}}%
    {\def\wtrf@thesubsection{\arabic{chapter}.\arabic{section}.\arabic{subsection}}}%
  \def\wtrf@scope{\wtrf@thesubsection:}}
\DeclareOption{global}{\@wtrf@use@scope@false}
\ExecuteOptions{global}
\ProcessOptions\relax

%%%% new ref
\def\newref#1{%
  \@ifundefined{wtrf@#1@namespace}%
    {\wtrf@newref{#1}}%
    {\wtrf@error{refname '#1' already exists}}}
\@onlypreamble\newref
\def\wtrf@newref#1{%
  % define namespace
  \wtrf@name@def{wtrf@#1@namespace}{#1:\wtrf@scope}%
  % define keys for setting styles
  \define@key[wtrf]{#1@style}{refcmd}{\wtrf@name@def{wtrf@#1@refcmd}####1{##1}}%
  \define@key[wtrf]{#1@style}{last sep}[\wtrf@name@use{wtrf@#1@sep}]{%
    \wtrf@name@def{wtrf@#1@last@sep}{##1}}%
  \define@cmdkeys[wtrf]{#1@style}[wtrf@#1@]{sep, prefix, suffix}%
  % default key settings
  \setkeys[wtrf]{#1@style}{%
    refcmd=\ref{##1},
    sep={,\space}, last sep,
    prefix={}, suffix={}}%
  % define label command
  \wtrf@name@def{#1label}##1{\label{#1:\wtrf@scope ##1}}%
  % define ref command
  \wtrf@name@def{#1ref}{%
    \wtrf@if@option@exist
      {\wtrf@name@use{wtrf@#1ref@with@option}}%
      {\wtrf@name@use{wtrf@#1@print}}}%
  % when option exist
  \wtrf@name@def{wtrf@#1ref@with@option}[##1]##2{%
    \begingroup
    \if@wtrf@use@scope@
      \def\wtrf@scope{##1:}%
    \else
      \let\wtrf@scope\@empty
    \fi
    \wtrf@name@use{wtrf@#1@print}{##2}%
    \endgroup}%
  % print refs
  \wtrf@name@def{wtrf@#1@print}##1{%
    \wtrf@tempcnta\z@\@for\wtrf@member:=##1\do{\advance\wtrf@tempcnta\@ne}%
    \ifnum\wtrf@tempcnta<\tw@
      \wtrf@name@use{wtrf@#1@prefix}%
      \wtrf@name@use{wtrf@#1@refcmd}{\wtrf@name@use{wtrf@#1@namespace}##1}%
      \wtrf@name@use{wtrf@#1@suffix}%
    \else
      \wtrf@tempcntb\@ne\advance\wtrf@tempcnta\m@ne
      \wtrf@name@use{wtrf@#1@prefix}
      \@for\wtrf@member:=##1\do{%
        \wtrf@name@use{wtrf@#1@refcmd}{\wtrf@name@use{wtrf@#1@namespace}\wtrf@member}%
        \ifnum\wtrf@tempcnta>\wtrf@tempcntb
          \wtrf@name@use{wtrf@#1@sep}%
        \fi
        \ifnum\wtrf@tempcnta=\wtrf@tempcntb
          \wtrf@name@use{wtrf@#1@last@sep}%
        \fi
        \advance\wtrf@tempcntb\@ne}%
      \wtrf@name@use{wtrf@#1@suffix}%
    \fi}}

%%%% set ref style
\def\setrefstyle#1#2{%
  \@ifundefined{wtrf@#1@namespace}%
    {\wtrf@error{refname '#1' does not exist}}%
    {\setkeys[wtrf]{#1@style}{#2}}}

%% EOF
